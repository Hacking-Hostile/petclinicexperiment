# Multi-Language CI/CD Pipeline - Execution Layer
# This workflow implements ONLY the Execution Layer (Just Commands) from the architecture diagram

name: 03 - Execution Layer

# =============================================================================
# EXECUTION LAYER - Just Commands
# =============================================================================

on:
  workflow_run:
    workflows: ["02 - Orchestration Layer"]
    types: [completed]

jobs:
  just-commands:
    name: ğŸš€ Dynamic Just Commands Execution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven
      - uses: taiki-e/install-action@just
      
      - name: Show available just commands
        run: |
          echo "ğŸ“‹ Available just commands:"
          just --list
          
      - name: Execute core just commands dynamically
        run: |
          echo "ğŸ”„ Executing core just commands..."
          
          # Get all available commands (cleaner approach)
          echo "ğŸ“‹ Available commands from justfile:"
          just --list
          
          # Define core commands that should always run in CI
          CORE_COMMANDS="detect status build test clean mvn-validate coverage"
          
          # Execute each core command if it exists
          for cmd in $CORE_COMMANDS; do
            if just --list | grep -q "$cmd"; then
              echo "ğŸ”„ Executing: just $cmd"
              just $cmd
              if [ $? -ne 0 ]; then
                echo "âŒ Command 'just $cmd' failed"
                exit 1
              fi
            else
              echo "âš ï¸  Command '$cmd' not found in justfile, skipping"
            fi
          done
          
      - name: Execute additional just commands
        run: |
          echo "ğŸ”„ Executing additional just commands..."
          
          # Execute other useful commands that actually exist in justfile
          ADDITIONAL_COMMANDS="lint format deploy cyclonedx-report"
          
          for cmd in $ADDITIONAL_COMMANDS; do
            if just --list | grep -q "$cmd"; then
              echo "ğŸ”„ Executing: just $cmd"
              just $cmd || echo "âš ï¸  Command 'just $cmd' failed but continuing..."
            else
              echo "âš ï¸  Command '$cmd' not found in justfile, skipping"
            fi
          done
          
      - name: Show just command details
        run: |
          echo "ğŸ“‹ Just command details:"
          echo "Build command:"
          just --show build || echo "No build command found"
          echo ""
          echo "Test command:"
          just --show test || echo "No test command found"
          echo ""
          echo "Clean command:"
          just --show clean || echo "No clean command found"
          
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            target/
            build/
            *.jar
            *.war
            *.ear
            
  execution-summary:
    name: ğŸ“Š Execution Summary
    runs-on: ubuntu-latest
    needs: just-commands
    steps:
      - run: |
          echo "ğŸ“Š EXECUTION LAYER SUMMARY"
          echo "âœ… Dynamic just command execution completed"
          echo "âœ… Commands executed from justfile"
          echo "âœ… Build artifacts uploaded"
          echo "âœ… All core commands processed"
