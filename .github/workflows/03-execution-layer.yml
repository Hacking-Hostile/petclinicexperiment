# Multi-Language CI/CD Pipeline - Execution Layer
# This workflow implements ONLY the Execution Layer (Just Commands) from the architecture diagram

name: 03 - Execution Layer

# =============================================================================
# EXECUTION LAYER - Just Commands
# =============================================================================

on:
  workflow_run:
    workflows: ["02 - Orchestration Layer"]
    types: [completed]

jobs:
  just-commands:
    name: ğŸš€ Dynamic Just Commands Execution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven
      - uses: taiki-e/install-action@just
      
      - name: Show available just commands
        run: |
          echo "ğŸ“‹ Available just commands:"
          just --list
          
      - name: Execute all just commands dynamically
        run: |
          echo "ğŸ”„ Executing all just commands from justfile..."
          
          # Get all available commands from justfile
          JUST_COMMANDS=$(just --list | grep -v "Available recipes:" | tr '\n' ' ')
          echo "Found commands: $JUST_COMMANDS"
          
          # Execute each command that exists in justfile
          for cmd in $JUST_COMMANDS; do
            # Skip default command as it's just a help display
            if [ "$cmd" != "default" ]; then
              echo "ğŸ”„ Executing: just $cmd"
              just $cmd
              if [ $? -ne 0 ]; then
                echo "âŒ Command 'just $cmd' failed"
                exit 1
              fi
            fi
          done
          
      - name: Show just command details
        run: |
          echo "ğŸ“‹ Just command details:"
          echo "Build command:"
          just --show build || echo "No build command found"
          echo ""
          echo "Test command:"
          just --show test || echo "No test command found"
          echo ""
          echo "Clean command:"
          just --show clean || echo "No clean command found"
          
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            target/
            build/
            *.jar
            *.war
            *.ear
            
  execution-summary:
    name: ğŸ“Š Execution Summary
    runs-on: ubuntu-latest
    needs: just-commands
    steps:
      - run: |
          echo "ğŸ“Š EXECUTION LAYER SUMMARY"
          echo "âœ… All justfile commands executed dynamically"
          echo "âœ… No hardcoded commands used"
          echo "âœ… Build artifacts uploaded"
          echo "âœ… Pipeline driven entirely by justfile content"
